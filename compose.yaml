services:
  app:
    build: .
    ports:
      - "4000:4000"  # API Gateway
      - "4001:4001"  # Notification Service
      - "4002:4002"  # Community Service
      - "4003:4003"  # Package Service
      - "4004:4004"  # Purchase Service
      - "4005:4005"  # User Service
      - "4006:4006"  # Mentor Service
      - "4007:4007"  # Learner Service
      - "4008:4008"  # Admin Service
      - "4010:4010"  # AI Service
      - "4011:4011"  # File Service
      - "5173:5173"  # Frontend
    env_file:
      - ./backend/.env.docker   # chỉ rõ đường dẫn tới file env trong backend
    environment:
      # Ensure DOCKER flag is set
      - DOCKER=true
      - NODE_ENV=production
      # Database connection (override from env_file if needed)
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=1234
      - DB_NAME=aesp
      # Service URLs - Trong Docker dùng localhost vì tất cả services chạy cùng container
      # Không override từ .env.docker, để code tự động dùng localhost khi không có env var
      - PACKAGE_SERVICE_URL=http://localhost:4003
      - NOTIFICATION_SERVICE_URL=http://localhost:4001
      - COMMUNITY_SERVICE_URL=http://localhost:4002
      - PURCHASE_SERVICE_URL=http://localhost:4004
      - USER_SERVICE_URL=http://localhost:4005
      - MENTOR_SERVICE_URL=http://localhost:4006
      - LEARNER_SERVICE_URL=http://localhost:4007
      - ADMIN_SERVICE_URL=http://localhost:4008
      - AI_SERVICE_URL=http://localhost:4010
      - FILE_SERVICE_URL=http://localhost:4011
    volumes:
      - .:/app
      - /app/node_modules
      - /app/backend/services/node_modules
      - /app/frontend/node_modules
    depends_on:
      db:
        condition: service_healthy
    networks:
      - aesp_network
    command: sh -c "if [ \"$NODE_ENV\" = \"production\" ]; then npm run start:prod; else npm run dev:all; fi"

  db:
    image: postgres:latest
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: aesp
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d aesp"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s  # Give DB time to start
    networks:
      - aesp_network

networks:
  aesp_network:
    driver: bridge

volumes:
  db_data:
